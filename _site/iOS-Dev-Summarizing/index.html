<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js">
<!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>iOS基础知识归纳总结 – KONY</title> <meta name="description" content="记录一位奋斗在互联网前线的80后奶爸的捣腾之路"> <meta name="keywords" content=""> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://localhost:4000/assets/img/me.png"> <meta name="twitter:title" content="iOS基础知识归纳总结"> <meta name="twitter:description" content="对iOS开发中runtime、多线程等知识点的归纳总结"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="iOS基础知识归纳总结"> <meta property="og:description" content="对iOS开发中runtime、多线程等知识点的归纳总结"> <meta property="og:url" content="http://localhost:4000/iOS-Dev-Summarizing/"> <meta property="og:site_name" content="KONY"> <meta property="og:image" content="http://localhost:4000/assets/img/me.png"> <link rel="canonical" href="http://localhost:4000/iOS-Dev-Summarizing/"> <link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="KONY Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css"> <!-- JS --> <script src="http://localhost:4000/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="http://localhost:4000/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png"> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico"> <!-- Background Image --> <style type="text/css">body {background-image:url(http://localhost:4000/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="http://localhost:4000/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="http://localhost:4000/assets/img/me.png" alt="KONY photo" class="author-photo"> <h4>KONY</h4> <p>记录一位奋斗在互联网前线的80后奶爸的捣腾之路</p> </li> <li><a href="http://localhost:4000/about/"><span class="btn btn-inverse">Learn More</span></a></li> </ul>
<!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="http://localhost:4000/posts/">All Posts</a></li> <li><a href="http://localhost:4000/tags/">All Tags</a></li> </ul> </li> <li><a href="http://localhost:4000/projects/">Projects</a></li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>iOS基础知识归纳总结</h1> <h4>16 Feb 2016</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~1 minute </p>
<!-- /.entry-reading-time --> <a class="btn zoombtn" href="http://localhost:4000/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <h2 id="section">底层原理</h2> <h4 id="weak">weak的实现</h4> <p>runtime为每个类对象都维护了一张全局的weak_table，里面的key是赋值对象的内存地址，value是weak修饰符的属性对象内存地址。当某个对象delloc的时候，系统会检查该类对象是否存在弱引用，如果存在则检查于之对应的weak_table，将所有能匹配到这个对象的value重新指向nil。</p> <p><a href="!http://www.cocoachina.com/ios/20150605/11990.html">weak的生命周期：具体实现方法</a></p> <h4 id="kvc">kvc的实现</h4> <p>kvc主要是根据类对象的isa指针和方法名，从method_list里面找到对应方法的函数指针，然后结合参数去执行。</p> <h4 id="kvo">kvo的实现</h4> <p>kvo主要运用了isa-swizzling的方法，在调用addObserve方法的时候，讲对象的isa指针指向了一个新的继承于当前类的子类对象，并添加了一个相同名字的setter方法在方法列表里面，在setter方法里面加上了willChangeValueForKey/didChangeValueForKey的触发。当我们调用了setter方法的时候，会先触发will然后再调用原类对象的setter方法再调用did。当调用removeObserve方法的时候，该对象的isa指针又重新指向了原类对象了。</p> <p><a href="http://www.nscookies.com/isa-swizzling/">isa-swizzling?什么鬼？</a></p> <p><a href="http://www.pluto-y.com/isa-swizzling-and-runtime/">从自己实现isa-swizzling到说一些Runtime的内容</a></p> <h4 id="gcd">GCD的实现</h4> <p>主要由libdispatch、Libc和XNU内核实现了GCD，通过C语言层面的管理线程的容器和FIFO队列维护这个过程。</p> <h4 id="block">block实现原理</h4> <div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="cp">#import "TestClass.h"
</span>
<span class="k">@implementation</span> <span class="nc">TestClass</span>

<span class="k">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="n">init</span>
<span class="p">{</span>
    <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">init</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">@"aaaaa"</span><span class="p">;</span>
        <span class="n">self</span><span class="p">.</span><span class="n">innerBlock</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">param</span><span class="p">){</span>
            <span class="n">NSLog</span><span class="p">(</span><span class="s">@"%@"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="n">self</span><span class="p">.</span><span class="n">innerBlock</span><span class="p">(</span><span class="s">@"bbbbb"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div> <p><img src="http://okxyl92j3.bkt.clouddn.com/Objective-C%E7%9A%84block_2.jpg" alt="C++下的Block"></p> <ul> <li>从画线和画圈处得知block本质上是一个函数指针，而且这个函数指针是包含在一个结构体里面，该结构体还会包含block参数的字段。</li> <li>箭头处可以发现为何说block会引用self。</li> </ul> <h2 id="ios">iOS内存管理机制</h2> <h4 id="section-1">基础部分</h4> <p>iOS的内存管理是通过引用数来管理对象的。在MRC的时期，需要自己手动地调用retain/release方法，在ARC时期，在静态编译阶段，编译器会分析代码在适当的地方添加retain/release/autorelease方法。</p> <h4 id="autorelease">autorelease</h4> <p>每一个线程在每一个runloop开始的时候都会创建一个autoreleasepool，系统会将autoreleased的对象放到这个pool里面。当这个runloop要结束的时候，系统会将pool里面的所有autoreleased对象进行释放。我们可以通过<a href="https://github.com/autoreleasepool" class="user-mention">@autoreleasepool</a>关键字去创建一个局部的autoreleasepool，当超过了这个作用域的时候，里面的autoreleased对象都会全部释放。<a href="https://github.com/autoreleasepool" class="user-mention">@autoreleasepool</a>适合解决创建大量临时对象。</p> <h4 id="section-2">问题</h4> <ul> <li>用什么方法在创建之后会放到autoreleasepool中？</li> </ul> <h2 id="block-1">block</h2> <h4 id="section-3">概念</h4> <p>具备保存上下文变量内存块的函数指针。OC的闭包。</p> <h4 id="block-2">__block实现原理</h4> <div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">__block</span> <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">mBlock</span><span class="p">)()</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"%d"</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"%d"</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
   <span class="p">};</span>
   <span class="n">mBlock</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div> <p><img src="http://okxyl92j3.bkt.clouddn.com/Objective-C%E4%B8%8B%E7%9A%84__block_2.jpg" alt="C++下的__block"></p> <ul> <li>__block其实是由一个传值过程变为传地址的过程。</li> </ul> <h2 id="section-4">多线程</h2> <h4 id="nsthread">NSThread</h4> <p>GCD和NSOperation会把对象添加到autoreleasepool中，但NSThread需要自己手动创建并触发释放。</p> <h3 id="gcd-1">GCD</h3> <h4 id="section-5">串行、并行、同步、异步</h4> <ul> <li>串行、并行是针对线程队列，同步、异步是针对线程的任务。</li> <li>系统对串行队列的调度是单条线程把任务一个一个地执行。</li> <li>系统对并行队列的调度是由系统管理多个线程去完成任务，任务之前无需等待。</li> <li>同步(sync)指当前线程会阻塞，等待同步线程完成当前任务后再去执行。</li> <li>异步(async)指当前线程不需要阻塞，可以直接执行当前任务。</li> <li>dispatch_get_main_queue是串行队列。</li> <li>dispatch_get_global_queue是并行队列。</li> </ul> <h4 id="section-6">锁种类</h4> <p><a href="http://www.cocoachina.com/ios/20161129/18216.html">iOS 中的各种锁</a></p> <h4 id="gcd-2">GCD实现同步</h4> <div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">dispatch_queue_t</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">dispatch_semaphore_t</span> <span class="n">semaphore</span> <span class="o">=</span> <span class="n">dispatch_semaphore_create</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">dispatch_aync</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
	<span class="n">dispatch_time_t</span> <span class="n">time</span> <span class="o">=</span> <span class="n">dispatch_time</span><span class="p">(</span><span class="n">DISPATCH_TIME_NOW</span><span class="p">,</span><span class="mi">10ull</span> <span class="o">*</span>  <span class="n">NSEC_PER_SEC</span><span class="p">);</span>
	<span class="n">dispatch_after</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
		<span class="n">NSLog</span><span class="p">(</span><span class="s">"111111"</span><span class="p">);</span>
		<span class="n">dispatch_semaphore_signal</span><span class="p">(</span><span class="n">semaphore</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">})</span>
<span class="n">dispatch_semaphore_wait</span><span class="p">(</span><span class="n">semaphore</span><span class="p">,</span> <span class="n">DISPATCH_TIME_FOREVER</span><span class="p">);</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">"2222222"</span><span class="p">);</span>
</code></pre></div> <h4 id="gcd-3">GCD实现单例</h4> <div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="n">shareInstance</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="n">dispatch_once_t</span> <span class="n">onceToken</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">id</span> <span class="n">instance</span><span class="p">;</span>
    <span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onceToken</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="p">[[</span><span class="n">self</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="n">instance</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div> <h2 id="runtime">runtime</h2> <h4 id="section-7">概念</h4> <p>runtime是运行于操作系统与应该用程序的一个中间层，为OC消息转发机制、运行时动态生成类、对象以和方法，消息转发机制，以及Method Swizzling提供基础，并且暴露一套C接口给应用者调用。</p> <h4 id="objectclassmetaclass">Object、Class、MetaClass的关系</h4> <p>NSObject的实现 <img src="http://okxyl92j3.bkt.clouddn.com/NSObject%E5%AE%9E%E7%8E%B0%E6%88%AA%E5%9B%BE.jpg" alt="NSObject"></p> <p>Class的实现 <img src="http://okxyl92j3.bkt.clouddn.com/Class%E5%AE%9E%E7%8E%B0%E6%88%AA%E5%9B%BE.jpg" alt="Class"></p> <p>objc_class的实现 <img src="http://okxyl92j3.bkt.clouddn.com/objc_class%E5%AE%9E%E7%8E%B0%E6%88%AA%E5%9B%BE.jpg" alt="objc_class"></p> <p>isa是对象指向的对应Class结构体的指针 <img src="http://okxyl92j3.bkt.clouddn.com/isa%E6%8C%87%E9%92%88%E6%88%AA%E5%9B%BE.jpg" alt="isa"></p> <p>在OC下面everything都是对象，instance是对象，class也是对象。</p> <h4 id="methodimpsel">Method、IMP、SEL的关系</h4> <p>objc_method_list指向的列表存储的正式Method。</p> <div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="k">struct</span> <span class="n">objc_method</span>
<span class="p">{</span>
	<span class="n">SEL</span> <span class="n">method_name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="n">method_types</span><span class="p">;</span>
	<span class="n">IMP</span> <span class="n">method_imp</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">objc_method</span> <span class="o">*</span> <span class="n">Method</span><span class="p">;</span>
</code></pre></div> <h4 id="section-8">“调用方法”的根本是“消息派发”</h4> <p>通过<em>clang -rewrite-objc</em> 把OC代码转成C++得到下图。 <img src="http://okxyl92j3.bkt.clouddn.com/%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E7%9A%84%E5%AE%9E%E9%99%85%E8%BF%87%E7%A8%8B.jpg" alt="消息派发"></p> <p>runtime会在当前isa指向的objc_class结构体里面的objc_cache搜索对应的Method,如果没有则会在objc_method_list继续搜索，如果还没有会在super_class逐层往上找。</p> <h4 id="section-9">消息转发机制</h4> <p>当runtime找不到某个方法的时候，它会给开发者机会去处理，这个处理的机制就是消息转发机制，而我们常说的消息转发机制其实分两个过程，动态决议和消息转发。</p> <p><img src="http://okxyl92j3.bkt.clouddn.com/%E6%B6%88%E6%81%AF%E8%BD%AC%E5%8F%91%E8%BF%87%E7%A8%8B.jpg" alt="消息转发机制"></p> <ul> <li>动态决议的resolveInstanceMethod和resolveClassMethod主要是针对当前对象。</li> <li>消息转发forwardingTargetForSelector和forwardInvocation是针对其他对象。</li> </ul> <h4 id="method-swizzling">Method swizzling</h4> <p><a href="http://tech.glowing.com/cn/method-swizzling-aop/">Method Swizzling 和 AOP 实践</a></p> <h2 id="runloop">runloop</h2> <h4 id="section-10">概念</h4> <ul> <li>runloop其实就是程序的事件循环机制，我们程序能不断地响应键盘、触碰等事件全靠它。</li> <li>runloop管理着所有我们需要处理的事件和消息，这些事件和消息都会经过“接受”-&gt;“等待”-&gt;“处理”这些状态。</li> </ul> <h4 id="runloop-1">runloop与线程的关系</h4> <p>系统有一个全局Map管理线程对象和runloop对象的一对一关系。当第一次去获取runloop对象的时候系统才会去初始化这个map，才会把主线程的runloop放到map管理。</p> <h4 id="runloopnstimer">runloop跟NSTimer的关系</h4> <p><a href="http://www.superqq.com/blog/2016/05/05/ios-nsrunllop-nstimer/">关于NSRunLoop和NSTimer的深入理解</a></p> <h4 id="section-11">原理实现</h4> <p>这一块后面单独写一篇详细的，给出链接。</p> <div class="entry-meta"> <br> <hr> <span class="entry-tags"></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/iOS-Dev-Summarizing/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/iOS-Dev-Summarizing/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=http://localhost:4000/iOS-Dev-Summarizing/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> </header> <!-- JS --> <script src="http://localhost:4000/assets/js/jquery-1.12.0.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.dlmenu.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.goup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.magnific-popup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.fitvid.min.js"></script> <script src="http://localhost:4000/assets/js/scripts.js"></script> <script type="text/javascript"> var disqus_shortname = 'taylantatli'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
